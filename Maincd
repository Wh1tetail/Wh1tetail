 // =========================
// WINFORMS CLIENT: Program.cs
// =========================
using Microsoft.Extensions.Configuration;
using Newtonsoft.Json.Linq;
using System.Net.Http;
using System.Net.Http.Headers;

namespace Ws2
{
    internal static class Program
    {
        [STAThread]
        static void Main()
        {
            ApplicationConfiguration.Initialize();

            var config = new ConfigurationBuilder()
                .SetBasePath(AppContext.BaseDirectory)
                .AddJsonFile("appsettings.json", optional: false, reloadOnChange: true)
                .Build();
            var baseUrl = config["ApiBaseUrl"]
                ?? throw new Exception("ApiBaseUrl not found in appsetting.json");

            var http = new HttpClient(new HttpClientHandler
            {
                ServerCertificateCustomValidationCallback = (m, c, cg, e) => true
            })
            {
                BaseAddress = new Uri(baseUrl)
            };

            var login = new Form1(http);
            if (login.ShowDialog() != DialogResult.OK || string.IsNullOrWhiteSpace(login.Token))
                return;

            http.DefaultRequestHeaders.Add("X-Session-Token", login.Token);

            Application.Run(new MainPage(http));
        }
    }
}

// =========================
// WINFORMS CLIENT: Form1.cs (Login)
// =========================
using System.Net.Http;
using System.Net.Http.Json;

namespace Ws2
{
    public partial class Form1 : Form
    {
        private readonly HttpClient _http;

        public string? Token { get; set; }
        public Form1(HttpClient http)
        {
            InitializeComponent();
            _http = http;
        }

        private async void btnLogin_Click(object sender, EventArgs e)
        {
            var resp = await _http.PostAsJsonAsync("api/Auth/Login",
                new { username = txtLogin.Text, password = txtPassword.Text });
            if (!resp.IsSuccessStatusCode)
            {
                MessageBox.Show("Wrong password");
                return;
            }
            var json = await resp.Content.ReadAsStringAsync();
            var obj = System.Text.Json.JsonDocument.Parse(json);
            Token = obj.RootElement.GetProperty("token").GetString();

            DialogResult = DialogResult.OK;
            Close();
        }

        private void btnClose_Click(object sender, EventArgs e)
        {
            Close();
        }
    }
}

// =========================
// WINFORMS CLIENT: MainPage.cs
// =========================
using System;
using System.Collections.Generic;
using System.Net.Http;
using System.Net.Http.Json;
using System.Threading.Tasks;
using System.Windows.Forms;
using Ws2.Models;

namespace Ws2
{
    public partial class MainPage : Form
    {
        private readonly HttpClient _http;

        public MainPage(HttpClient http)
        {
            InitializeComponent();
            _http = http;
            this.Load += async (_, __) => await LoadData();
        }

        private async Task LoadData()
        {
            try
            {
                var list = await _http.GetFromJsonAsync<List<Request>>("api/Requests") ?? new();
                dataGridView1.DataSource = list;
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Load Data ERROR: {ex.Message}");
            }
        }

        private async void btnLoad_Click(object sender, EventArgs e)
        {
            await LoadData();
        }

        private async void btnAdd_Click(object sender, EventArgs e)
        {
            try
            {
                var newReq = new Request
                {
                    Title = "New request",
                    Status = "New",
                    CreatedAt = DateTime.Now,
                };

                var response = await _http.PostAsJsonAsync("api/Requests", newReq);
                if (response.IsSuccessStatusCode)
                {
                    MessageBox.Show("Request added");
                    await LoadData();
                }
                else
                {
                    MessageBox.Show("Error adding");
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Error: {ex.Message}");
            }
        }

        private async void btnDone_Click(object sender, EventArgs e)
        {
            if (dataGridView1.CurrentRow?.DataBoundItem is Request selected)
            {
                selected.Status = "Completed";
                var responce = await _http.PutAsJsonAsync($"api/Requests/{selected.Id}", selected);
                if (responce.IsSuccessStatusCode)
                {
                    MessageBox.Show("Request status updated to 'Completed'");
                    await LoadData();
                }
            }
        }

        private async void btnDelete_Click(object sender, EventArgs e)
        {
            if (dataGridView1.CurrentRow?.DataBoundItem is Request selected)
            {
                var responce = await _http.DeleteAsync($"api/Requests/{selected.Id}");
                if (responce.IsSuccessStatusCode)
                {
                    MessageBox.Show("Request deleted");
                    await LoadData();
                }
            }
        }
    }
}

// =========================
// WINFORMS CLIENT: Models/Request.cs
// =========================
using System;

namespace Ws2.Models
{
    public class Request
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public string? Status { get; set; }
        public int? DeptId { get; set; }
        public int? AuthorId { get; set; }
        public DateTime CreatedAt { get; set; }
    }
}

// =========================
// WINFORMS CLIENT: appsettings.json (как текст)
// =========================
// {
//   "ApiBaseUrl": "https://localhost:7136/"
// }

// =========================
// WEB API: Program.cs
// =========================
using Microsoft.EntityFrameworkCore;
using WSApi.Data;

var builder = WebApplication.CreateBuilder(args);

builder.Services.AddControllers();
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

builder.Services.AddDbContext<AppDbContext>(opt =>
    opt.UseSqlServer(builder.Configuration.GetConnectionString("DefaultConnection")));

builder.Services.AddApplicationInsightsTelemetry();

var app = builder.Build();

if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseHttpsRedirection();
app.UseAuthorization();
app.MapControllers();
app.Run();

// =========================
// WEB API: AppDbContext.cs + модели
// =========================
using Microsoft.EntityFrameworkCore;

namespace WSApi.Data
{
    public class AppDbContext : DbContext
    {
        public AppDbContext(DbContextOptions<AppDbContext> options) : base(options) { }

        public DbSet<User> Users => Set<User>();
        public DbSet<Department> Departments => Set<Department>();
        public DbSet<Request> Requests => Set<Request>();

        protected override void OnModelCreating(ModelBuilder b)
        {
            b.Entity<User>().ToTable("Users", "app");
            b.Entity<Department>().ToTable("Departments", "app");
            b.Entity<Request>().ToTable("Requests", "app");
        }
    }

    public class User
    {
        public int Id { get; set; }
        public string UserName { get; set; } = string.Empty;
        public string DisplayName { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public int? DeptId { get; set; }
        public bool IsActive { get; set; }
        public DateTime CreatedAt { get; set; }
        public string? Password { get; set; }
    }

    public class Department
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public bool IsActive { get; set; }
        public DateTime CreatedAt { get; set; }
    }

    public class Request
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public string? Status { get; set; }
        public int? DeptId { get; set; }
        public int? AuthorId { get; set; }
        public DateTime CreatedAt { get; set; }
    }
}

// =========================
// WEB API: AuthController.cs
// =========================
using Microsoft.EntityFrameworkCore;
using Microsoft.AspNetCore.Mvc;
using WSApi.Data;

namespace WSApi.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class AuthController : ControllerBase
    {
        private readonly AppDbContext _db;
        public AuthController(AppDbContext db) => _db = db;

        public record LoginDto(string Username, string Password);

        [HttpPost("login")]
        public async Task<IActionResult> Login(LoginDto dto)
        {
            var user = await _db.Users.SingleOrDefaultAsync(u => u.UserName == dto.Username && u.IsActive);
            if (user == null || user.Password != dto.Password) return Unauthorized();

            var token = Guid.NewGuid().ToString();
            SessionStore.Add(token, user.Id);

            return Ok(new { token });
        }

        public class SessionStore
        {
            private static readonly Dictionary<string, int> _sessions = new();
            public static void Add(string token, int userId) => _sessions[token] = userId;
            public static int? GetUser(string token) => _sessions.TryGetValue(token, out var id) ? id : null;
        }
    }
}

// =========================
// WEB API: RequestsController.cs
// =========================
using Microsoft.EntityFrameworkCore;
using Microsoft.AspNetCore.Mvc;
using WSApi.Data;

namespace WSApi.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class RequestsController : ControllerBase
    {
        private readonly AppDbContext _db;
        public RequestsController(AppDbContext db) => _db = db;

        [HttpGet]
        public async Task<IEnumerable<Request>> GetAll() =>
            await _db.Requests.AsNoTracking()
                .OrderByDescending(r => r.CreatedAt)
                .ToListAsync();

        [HttpGet("{id}")]
        public async Task<ActionResult<Request>> GetOne(int id)
        {
            var r = await _db.Requests.SingleOrDefaultAsync(r => r.Id == id);
            if (r == null) return NotFound();
            return r;
        }

        [HttpPost]
        public async Task<ActionResult<Request>> Create(Request model)
        {
            model.CreatedAt = DateTime.Now;
            _db.Requests.Add(model);
            await _db.SaveChangesAsync();
            return CreatedAtAction(nameof(GetOne), new { id = model.Id }, model);
        }

        [HttpPut("{id}")]
        public async Task<IActionResult> Update(int id, Request model)
        {
            var r = await _db.Requests.FindAsync(id);
            if (r == null) return NotFound();

            r.Title = model.Title;
            r.Status = model.Status;
            r.CreatedAt = model.CreatedAt;
            r.DeptId = model.DeptId;

            await _db.SaveChangesAsync();
            return Ok(r);
        }

        [HttpDelete("{id}")]
        public async Task<IActionResult> Delete(int id)
        {
            var r = await _db.Requests.FindAsync(id);
            if (r == null) return NotFound();

            _db.Requests.Remove(r);
            await _db.SaveChangesAsync();
            return Ok();
        }

        [HttpGet("by-dept")]
        public async Task<IEnumerable<object>> ByDept() =>
            await _db.Requests
                .GroupBy(r => r.DeptId)
                .Select(g => new
                {
                    DeptId = g.Key,
                    DeptName = _db.Departments.Where(d => d.Id == g.Key)
                        .Select(d => d.Name)
                        .FirstOrDefault(),
                    Count = g.Count()
                })
                .ToListAsync();
    }
}

// =========================
// WEB API: DepartmentController.cs
// =========================
using Microsoft.EntityFrameworkCore;
using Microsoft.AspNetCore.Mvc;
using WSApi.Data;

namespace WSApi.Controllers
{
    [ApiController]
    [Route("api/[controller]")]
    public class DepartmentController : ControllerBase
    {
        private readonly AppDbContext _db;
        public DepartmentController(AppDbContext db) => _db = db;

        [HttpGet]
        public async Task<IEnumerable<Department>> Getall() =>
            await _db.Departments.AsNoTracking().ToListAsync();
    }
}

// =========================
// WEB API: appsettings.json (как текст)
// =========================
// {
//   "ConnectionStrings": {
//     "DefaultConnection": "Server=FOXPROBOOK\\SQLEXPRESS;Database=KmgDemo;Trusted_Connection=True;TrustServerCertificate=True"
//   },
//   "Logging": {
//     "LogLevel": {
//       "Default": "Information",
//       "Microsoft.AspNetCore": "Warning"
//     }
//   },
//   "AllowedHosts": "*"
// }

// =========================
// PYTHON: Аналитика данных (Anaconda / Jupyter)
// =========================
// Ниже — пример скрипта анализа таблицы app.Requests в Python

// ```python
// import pandas as pd
// import matplotlib.pyplot as plt
// import pyodbc
//
// connection_string = (
//     'DRIVER={ODBC Driver 17 for SQL Server};'
//     'SERVER=FOXPROBOOK\\\\SQLEXPRESS;'
//     'DATABASE=KmgDemo;'
//     'Trusted_Connection=yes;'
// )
//
// conn = pyodbc.connect(connection_string)
// query = 'SELECT Id, Title, Status, DeptId, AuthorId, CreatedAt FROM [app].[Requests]'
// df = pd.read_sql(query, conn)
//
// # Анализ 1: заявки по отделам
// count_by_dept = df.groupby('DeptId')['Id'].count().reset_index()
// count_by_dept.columns = ['DeptId', 'RequestCount']
// plt.bar(count_by_dept['DeptId'], count_by_dept['RequestCount'])
// plt.title('Количество заявок по отделам')
// plt.show()
//
// # Анализ 2: динамика по месяцам
// df['CreatedAt'] = pd.to_datetime(df['CreatedAt'])
// requests_by_month = df.groupby(df['CreatedAt'].dt.to_period('M')).size()
// requests_by_month.plot(kind='line', marker='o')
// plt.title('Динамика заявок по месяцам')
// plt.show()
//
// # Анализ 3: распределение статусов
// status_counts = df['Status'].value_counts()
// status_counts.plot(kind='pie', autopct='%1.1f%%')
// plt.title('Распределение заявок по статусам')
// plt.show()
//
// df.to_csv('requests_report.csv', index=False)
// ```

// =========================
// POWER BI: Визуализация данных
// =========================
// 1. Подключение к SQL Server: FOXPROBOOK\\SQLEXPRESS, база KmgDemo
// 2. Загрузка таблицы app.Requests
// 3. Визуализации:
//    - Столбчатая диаграмма: DeptId vs Count(Id)
//    - Линейная диаграмма: Месяц(CreatedAt) vs Count(Id)
//    - Круговая диаграмма: Status vs Count(Id)
// 4. KPI: всего заявок, завершённых, активных отделов и среднее в месяц.
// Модель актива
public class Asset
{
    public int AssetId { get; set; }
    public string Name { get; set; } = null!;
    public string AssetTag { get; set; } = null!;
    public int AssetTypeId { get; set; }
    public string? Location { get; set; }
    public string? Status { get; set; }

    public AssetType AssetType { get; set; } = null!;
}

public class AssetType
{
    public int AssetTypeId { get; set; }
    public string Name { get; set; } = null!;
    public ICollection<Asset> Assets { get; set; } = new List<Asset>();
}

public class ServiceRequest
{
    public int RequestId { get; set; }
    public int AssetId { get; set; }
    public DateTime CreatedAt { get; set; }
    public string Status { get; set; } = null!;
    public string? Description { get; set; }
    public string? AssignedTo { get; set; }

    public Asset Asset { get; set; } = null!;
}

// DbContext
public class KmgMobileContext : DbContext
{
    public KmgMobileContext(DbContextOptions<KmgMobileContext> options)
        : base(options) { }

    public DbSet<Asset> Assets => Set<Asset>();
    public DbSet<AssetType> AssetTypes => Set<AssetType>();
    public DbSet<ServiceRequest> ServiceRequests => Set<ServiceRequest>();
}

var builder = WebApplication.CreateBuilder(args);

// Добавляем DbContext
builder.Services.AddDbContext<KmgMobileContext>(options =>
    options.UseSqlServer(builder.Configuration.GetConnectionString("KmgMobile")));

// Добавляем контроллеры
builder.Services.AddControllers();
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

var app = builder.Build();

// Swagger для тестирования
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseHttpsRedirection();
app.MapControllers();
app.Run();


[ApiController]
[Route("api/[controller]")]
public class AssetsController : ControllerBase
{
    private readonly KmgMobileContext _context;

    public AssetsController(KmgMobileContext context)
    {
        _context = context;
    }

    // GET api/assets
    [HttpGet]
    public async Task<ActionResult<IEnumerable<Asset>>> GetAssets()
    {
        return await _context.Assets
            .Include(a => a.AssetType)
            .ToListAsync();
    }

    // GET api/assets/5
    [HttpGet("{id:int}")]
    public async Task<ActionResult<Asset>> GetAsset(int id)
    {
        var asset = await _context.Assets
            .Include(a => a.AssetType)
            .FirstOrDefaultAsync(a => a.AssetId == id);

        if (asset == null)
            return NotFound();

        return asset;
    }

    // POST api/assets
    [HttpPost]
    public async Task<ActionResult<Asset>> CreateAsset(Asset asset)
    {
        _context.Assets.Add(asset);
        await _context.SaveChangesAsync();

        return CreatedAtAction(nameof(GetAsset), new { id = asset.AssetId }, asset);
    }
}



mb

<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             x:Class="KMG.Mobile.Module1.AssetsPage"
             Title="Активы">
    <RefreshView Command="{Binding LoadCommand}">
        <CollectionView ItemsSource="{Binding Assets}">
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <StackLayout Padding="10">
                        <Label Text="{Binding Name}" FontAttributes="Bold" />
                        <Label Text="{Binding AssetTag}" FontSize="12" />
                        <Label Text="{Binding Status}" FontSize="12" />
                    </StackLayout>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>
    </RefreshView>
</ContentPage>



public class AssetDto
{
    public int AssetId { get; set; }
    public string Name { get; set; } = "";
    public string AssetTag { get; set; } = "";
    public string? Status { get; set; }
}

public class AssetApiService
{
    private readonly HttpClient _httpClient;

    public AssetApiService()
    {
        _httpClient = new HttpClient
        {
            BaseAddress = new Uri("https://localhost:5001/") // свой URL API
        };
    }

    public async Task<List<AssetDto>> GetAssetsAsync()
    {
        var response = await _httpClient.GetAsync("api/assets");
        response.EnsureSuccessStatusCode();

        var json = await response.Content.ReadAsStringAsync();

        return JsonSerializer.Deserialize<List<AssetDto>>(json,
            new JsonSerializerOptions { PropertyNameCaseInsensitive = true })!;
    }
}


public class AssetsViewModel : INotifyPropertyChanged
{
    private readonly AssetApiService _service = new();

    public ObservableCollection<AssetDto> Assets { get; } = new();

    public ICommand LoadCommand { get; }

    public event PropertyChangedEventHandler? PropertyChanged;

    public AssetsViewModel()
    {
        LoadCommand = new Command(async () => await LoadAsync());
    }

    private async Task LoadAsync()
    {
        var list = await _service.GetAssetsAsync();
        Assets.Clear();
        foreach (var a in list)
            Assets.Add(a);
    }
}


public partial class AssetsPage : ContentPage
{
    public AssetsPage()
    {
        InitializeComponent();
        BindingContext = new AssetsViewModel();
    }
}